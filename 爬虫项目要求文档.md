# 爬虫项目要求文档

**讨论爬虫相关设计要求**

- 设计规范
  - 数据存储
    - 批量入库
    - 分库
    - 索引
    - 数据版本
    - 数据库故障主动保存数据到本地
  - 失败重试
  - 去重自动清除
  - 日志规范
  - 如果需要登陆，登陆和爬虫的分离设计，和可以远程为爬虫更新cookies
  - 断点重跑
  - 第三方服务应用主备设计
  - 原始数据保存（数据类型，版本，解析器版本）
  - 时间需要指定时区
  - 尽可能设计多种匹配方案
  - 模块化
    - 爬取
    - 解析（版本）
    - 存储
- 异常检查
  - 检查数据结构是否改变，并采取相应措施
  - 数据类型校验
  - 数据入库检查
  - 爬虫心跳验活机制
  - 数据检查
    - 数据量
    - 每条数据大小
    - 为空率统计
- 其他
  - 第三方服务余额监控
- 代码规范

目前已存在的项目问题

目前需要分期完善每个爬虫保障性设计。

需要汇总所有的事故和基础平台的开发，分析原因，得出第一期所有已存在的爬虫需要跟进的保障性设计

项目文档列表：

汽车之家

<https://github.com/zaoshu/autohome/blob/develop/autohome.md>

目前未设计任何保障性设计

宜人贷

<https://github.com/zaoshu/Soros/blob/develop/yirendai.md>

目前未设计任何保障性设计

rong360

<https://github.com/zaoshu/Soros/blob/develop/rong360.md>

目前未设计任何保障性设计

事故报告

## 问题记录

| Date       | 数据源                | 问题描述                                     | 设计缺陷                            |
| ---------- | ------------------ | ---------------------------------------- | ------------------------------- |
| 2018/01/29 | YRD                | 宜定盈 Nsold_fact, Nsold_info, 2018/1/24 15:57--1/29 21:41 缺数据.所有表中时间类型已清洗为UTC时间(不包括 Nlender_per_elite_fact 的 new_date 字段 |                                 |
| 2018/01/29 | JT                 | 论坛发帖数抓取有问题                               | 爬虫心跳验活机制                        |
| 2018/01/30 | YRD                | 精英标2018/1/22-2018/1/30 Nlender_per_elite_fact 表和Nelite_fact数据不全或丢失，已补全，bug已修复 | 检查数据结构是否改变，并且根据数据结构是否改变判断是否暂停系统 |
| 2018/01/30 | JT                 | 论坛发帖数抓取有问题                               | 爬虫心跳验活机制                        |
| 2018/01/31 | YRD                | 线上redis崩了，Nborrower_info少了30min数据        | 第三方服务应用主备设计                     |
| 2018/01/31 | YRD                | 线上redis崩了，Nborrower_info少了4点50-10点数据 数据  | 第三方服务应用主备设计                     |
| 2018/02/02 | JT                 | 因部署问题，代码被回推，论坛发帖数未抓取；推荐接口数据缺失，主要是接入的打码平台api故障 | 第三方服务应用主备设计                     |
| 2018/02/03 | JT                 | 因部署问题，代码被回推，论坛发帖数未抓取                     | 爬虫心跳验活机制                        |
| 2018/02/04 | JT                 | 因部署问题，代码被回推，论坛发帖数未抓取                     | 爬虫心跳验活机制                        |
| 2018/02/04 | HTHT               | 因Redis问题导致RoomPrice数据缺失                  | 第三方服务应用主备设计                     |
| 2018/02/05 | HTHT               | 因部署问题，导致定时任务没有执行，该天数据丢失                  | 爬虫心跳验活机制                        |
| 2018/02/05 | YY                 | 程序 BUG 导致 2018-2-5 20:00:00 至 2018-2-6 10:30:00 数据丢失 |                                 |
| 2018/02/05 | YRD                | 精英标数据漏抓，今天补抓，数据不全                        |                                 |
| 2018/02/06 | YRD                | 部署问题，Docker暂停，Nborrower_info漏抓小部分数据      | 爬虫心跳验活机制                        |
| 2018/02/07 | YY                 | Out of memory 崩溃后程序重启失败                  |                                 |
| 2018/02/08 | YY                 | Out of memory 崩溃后程序重启失败                  |                                 |
| 2018/02/06 | ATHM               | used_car 由于openSSL错误，数据漏抓                |                                 |
| 2018/02/07 | ATHM               | 汽车之家登陆和注册页面都挂了，inquery_price缺2018/2/07的数据 | 检查数据结构是否改变，并且根据数据结构是否改变判断是否暂停系统 |
| 2018/02/08 | ATHM               | 汽车之家登陆和注册页面都挂了，inquery_price缺2018/2/08的数据 | 检查数据结构是否改变，并且根据数据结构是否改变判断是否暂停系统 |
| 2018/02/09 | YY                 | 程序崩溃后未正常重启                               |                                 |
| 2018/02/12 | HTHT               | 爬虫没有启动，部署问题。                             | 爬虫心跳验活机制                        |
| 2018/02/13 | HTHT               | 爬虫没有启动，部署问题。                             | 爬虫心跳验活机制                        |
| 2018/02/17 | YRD                | 爬虫停止，未及时检查到，Nborrower_info漏抓当天数据         | 爬虫心跳验活机制                        |
| 2018/02/19 | LIANJIA_ERSHOUFANG | 部分数据丢失，前天爬虫未关，导致2W条数据被去重掉                | 去重系统应该设计自动的清除机制                 |
| 2018/02/27 | ATHM               | 线上部署问题，没爬取成功影响数据表：2018/2/26的agents，auction_price_new，used_car_dealer_new，used_car_detail_new，2018/2/27的test_drive | 爬虫心跳验活机制                        |
| 2018/02/22 | JT                 | 短信码平台余额不足导致推荐模块数据未抓取，缺少十个小时的数据           | 第三方服务余额监控第三方服务应用主备设计            |
| 2018/03/01 | YRD                | yrd_api爬虫Nborrower_info丢失凌晨2点-10点的数据，原因，retry_times使用默认值2次，导致爬虫关闭 | 科学的重试系统。                        |
| 2018/03/01 | HTHT               | Room Count 爬虫没有跑，不知道为啥，需要及时解决。这部分缺失不会对业务造成什么影响。 | 爬虫心跳验活机制                        |
| 2018/03/01 | ATHM_API           | 询价爬虫inquery_price.py代理挂了。账户里有下订单，手动入库，不影响数据。 | 爬虫心跳验活机制                        |
| 2018/03/01 | JT                 | 短信码平台API失效导致推荐模块数据未抓取                    | 第三方服务应用主备设计                     |
| 2018/03/02 | ATHM_API           | 昨天代码merge了，但没确认。询价爬虫inquery_price.py代理挂了。账户里有下订单，手动入库，不影响数据。 | 爬虫心跳验活机制                        |
| 2018/03/02 | HTHT               | 线上爬虫有个预定时间的业务BUG,目前HTHT最大预定天数有2个条件(最多三个月和最多90天)。本地跑了数据补上了,BUG今天修复更上。 |                                 |
| 2018/03/04 | YY                 | 内存不足导致频繁重启，重启的过程中会丢失数据，暂时无法加内存，尝试开启 swap (不行)，更换至更大内存的服务器，丢失1-2MM条礼物数据（平均5-7MM） |                                 |
|            |                    |                                          |                                 |
|            |                    |                                          |                                 |
|            |                    |                                          |                                 |

观察事故文档得出目前通用性的一些事故原因：

- redis崩溃导致的事故有三次
- 短信服务暂停导致的事故为两次
- 重试系统设计的不科学导致的问题一次
- 其中做多的为，部署以后无法得知爬虫是否真的在执行
- 页面结构改变

对应的设计缺陷统计：

- 爬虫心跳验活机制   10
- 科学的重试系统 1
- 第三方服务应用主备设计 6
- 检查数据结构是否改变，并且根据数据结构是否改变判断是否暂停系统 3
- 去重系统应该设计自动的清除机制      1