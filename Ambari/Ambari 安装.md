# Ambari 安装



Mysql-connector

http://www.java2s.com/Code/JarDownload/mysql/mysql-connector-java.jar.zip



设置mysql 数据库连接

```
ambari-server setup --jdbc-db=mysql --jdbc-driver=/usr/share/java/mysql-connector-java-8.0.12.jar
```



/usr/share/java/mysql-connector-java.jar

```

[root@ambari ~]# ambari-server setup
Using python  /usr/bin/python
Setup ambari-server
Checking SELinux...
SELinux status is 'enabled'
SELinux mode is 'permissive'
WARNING: SELinux is set to 'permissive' mode and temporarily disabled.
OK to continue [y/n] (y)? 

Customize user account for ambari-server daemon [y/n] (n)? 

```

```
hostnamectl set-hostname hadoop7.bigdata.org

cat > /etc/resolv.conf <<EOF
# Generated by NetworkManager
search bigdata.org
nameserver 172.16.17.140
EOF

ping hadoop1.bigdata.org

-------------------------
vim /etc/resolv.conf
nameserver 172.16.17.140

cd /etc/yum.repos.d/
wget https://dns.metaapp.org/repos/ambari.repo --no-check-certificate

# 所有节点安装
yum install ambari-agent -y 
systemctl enable ambari-agent 
systemctl restart ambari-agent && systemctl status ambari-agent
```

密钥安装

```
# 在主节点生成密钥匙

ssh-keygen -t rsa

# 生成 秘钥后分发

cd .ssh
id_rsa

ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.16.17.120


#
/root/.ssh/id_rsa.pub

```

ambari-agent 安装

```


# 安装ambari-agent
yum install ambari-agent*.rpm

# vim /etc/ambari-agent/ambari.ini ,确保[server]部分下的hostname指向实际的Ambari Server主机，而不是“localhost”。
...
[server]
hostname=localhost
 
...

# 启动服务
ambari-agent start
```





关掉防火墙

```
firewall-cmd --state
systemctl disable firewalld.service 
systemctl stop firewalld.service
```

1、firewalld的基本使用

```
启动： systemctl start firewalld
关闭： systemctl stop firewalld
查看状态： systemctl status firewalld 
开机禁用  ： systemctl disable firewalld
开机启用  ： systemctl enable firewalld

```



关闭SElinux

```
vi /etc/sysconfig/selinux
SELINUX=disabled
```





创建数据库

```
172.16.16.21
ZHvfH6tXim-
root
ALTER USER 'root'@'localhost' IDENTIFIED BY 'K7kl32da4o2d-';
update user set authentication_string=password('K7kl32da4o2d-') where user='root';
SET PASSWORD = PASSWORD('K7kl32da4o2d-');

ranger
CREATE DATABASE IF NOT EXISTS ranger default charset utf8 COLLATE utf8_general_ci;

CREATE USER 'rangeradmin'@'%' IDENTIFIED BY 'K7kl32da4o2d-';
GRANT all ON ranger.* TO 'rangeradmin'@'%';

rangerkms
CREATE DATABASE IF NOT EXISTS rangerkms default charset utf8 COLLATE utf8_general_ci;

CREATE USER 'rangerkms'@'%' IDENTIFIED BY 'K7kl32da4o2d-';
GRANT all ON rangerkms.* TO 'rangerkms'@'%';


superset
CREATE DATABASE IF NOT EXISTS superset default charset utf8 COLLATE utf8_general_ci;

CREATE USER 'superset'@'%' IDENTIFIED BY 'K7kl32da4o2d-';
GRANT all ON superset.* TO 'superset'@'%';

hive
CREATE DATABASE IF NOT EXISTS hive default charset utf8 COLLATE utf8_general_ci;

CREATE USER 'hive'@'%' IDENTIFIED BY 'K7kl32da4o2d-';
GRANT all ON hive.* TO 'hive'@'%';

druid
CREATE DATABASE IF NOT EXISTS druid default charset utf8 COLLATE utf8_general_ci;

CREATE USER 'druid'@'%' IDENTIFIED BY 'K7kl32da4o2d-';
GRANT all ON druid.* TO 'druid'@'%';

oozie
CREATE DATABASE IF NOT EXISTS oozie default charset utf8 COLLATE utf8_general_ci;

CREATE USER 'oozie'@'%' IDENTIFIED BY 'K7kl32da4o2d-';
GRANT all ON oozie.* TO 'oozie'@'%';


ambari
CREATE DATABASE IF NOT EXISTS ambari default charset utf8 COLLATE utf8_general_ci;

CREATE USER 'ambari'@'%' IDENTIFIED BY 'K7kl32da4o2d-';
GRANT all ON ambari.* TO 'ambari'@'%';

azkaban
CREATE DATABASE IF NOT EXISTS ambari default charset utf8 COLLATE utf8_general_ci;

CREATE USER 'azkaban'@'%' IDENTIFIED BY 'K7kl32da4o2d-';
GRANT all ON azkaban.* TO 'azkaban'@'%';

meta
CREATE USER 'meta'@'%' IDENTIFIED BY 'K7kl32da4o2d-';
GRANT all ON *.* TO 'meta'@'%';




appdata
CREATE DATABASE IF NOT EXISTS appdata default charset utf8 COLLATE utf8_general_ci;

CREATE USER 'appdata'@'%' IDENTIFIED BY 'KVdawj08kna-';
GRANT all ON appdata.* TO 'appdata'@'%';
```





```
/var/log/hadoop
/hadoop/hdfs/data
/hadoop/hdfs/namenode

yum
/hadoop/yarn/log
/app-logs
/var/log/hadoop-yarn

/var/log/hadoop-mapreduce
/var/log/hive
/tmp/hive/operation_logs
/var/log/hbase
/var/log/oozie
/var/log/zookeeper
/var/log/storm
/var/log/accumulo
/var/log/ambari-infra-solr-client
/var/log/ambari-infra-solr
/var/log/ambari-metrics-monitor
/var/log/ambari-metrics-collector
/var/log/ambari-metrics-grafana
/var/log/ambari-metrics-collector
/var/log/atlas
/var/log/kafka
/var/run/knox
/var/log/ambari-logsearch-portal
/var/log/ambari-logsearch-logfeeder
/var/log/ranger/usersync
/var/log/ranger/tagsync
/var/log/ranger/kms
/var/log/livy2
/var/log/spark2
/var/log/zeppelin
```



用户

```
Users/Groups	Usernames
Smoke User	

ambari-qa
Hadoop Group	

hadoop
Accumulo User	

accumulo
Infra Solr User	

infra-solr
Ambari Metrics User	

ams
Metadata User	

atlas
Druid User	

druid
HBase User	

hbase
HDFS User	

hdfs
Proxy User Group	

users
Hive User	

hive
Kafka User	

kafka
Knox Group	

knox
Knox User	

knox
Log Search User	

logsearch
Mapreduce User	

mapred
Oozie User	

oozie
Ranger Group	

ranger
Ranger User	

ranger
Kms Group	

kms
Kms User	

kms
Livy2 Group	

livy
Livy2 User	

livy
Spark2 Group	

spark
Spark2 User	

spark
Sqoop User	

sqoop
Storm User	

storm
Superset User	

superset
Tez User	

tez
Yarn ATS User	

yarn-ats
Yarn User	

yarn
Zeppelin Group	

zeppelin
Zeppelin User	

zeppelin
ZooKeeper User	

zookeeper

```

```
The cluster consists of 3 hosts
3 warnings
Master services installed
SNameNode installed on hadoop2.bigdata.org
NameNode installed on hadoop1.bigdata.org
ResourceManager installed on hadoop1.bigdata.org
History Server installed on hadoop2.bigdata.org
HiveServer2 installed on hadoop2.bigdata.org
HBase Master installed on hadoop1.bigdata.org
Oozie Server installed on hadoop1.bigdata.org
```



安装完成后，服务无法启动：修复问题

```
HDFS

```





终于在参考别人的blog之后，找到命令删除的方式



\1. 查询资源

```sql
curl -u admin:admin -H “X-Requested-By: ambari” -X GET http://10.21.23.29:8080/api/v1/clusters/beta_eu/services/
```



\2. 删除资源

```sql
curl -u admin:admin -H "X-Requested-By: ambari" -X DELETE http://10.21.23.29:8080/api/v1/clusters/beta_eu/services/KAFKA
```



\3. 如果删除失败，先stop在删除

```sql
#curl -u admin:admin -H "X-Requested-By: ambari" -X DELETE http://10.21.23.29:8080/api/v1/clusters/beta_eu/services/APPCONFIGURATION
{
  "status" : 500,
  "message" : "org.apache.ambari.server.controller.spi.SystemException: An internal system exception occurred: Cannot remove beta_eu/APPCONFIGURATION. One or more host components are in a non-removable state."
```



\4. 停止service

```sql
[root@ip-10-21-23-29 ~]#  curl -u admin:admin -H "X-Requested-By: ambari" -X PUT -d '{"RequestInfo":{"context":"Stop Service"},"Body":{"ServiceInfo":{"state":"INSTALLED"}}}' 10.21.23.29:8080/api/v1/clusters/beta_eu/services/APPCONFIGURATION
{  "href" : "http://10.21.23.29:8080/api/v1/clusters/beta_eu/requests/24",
  "Requests" : {
    "id" : 24,
    "status" : "Accepted"  }
```



\5. 删除service

```sql
[root@ip-10-21-23-29 ~]#curl -u admin:admin -H "X-Requested-By: ambari" -X DELETE http://10.21.23.29:8080/api/v1/clusters/beta_eu/services/APPCONFIGURATION
```



\6. 再次检查，已经没有service了

```sql
[root@ip-10-21-23-29 ~]#  curl -u admin:admin -H “X-Requested-By: ambari” -X GET http://10.21.23.29:8080/api/v1/clusters/beta_eu/services/
curl: (6) Couldn't resolve host 'ambari”'
{
  "href" : "http://10.21.23.29:8080/api/v1/clusters/beta_eu/services/",
  "items" : [ ]
```





参考链接

http://blog.csdn.net/chengyuqiang/article/details/61195805





停掉Ambari 集群[有问题]

 清除ambari中旧的集群，只需要停掉ambari-server服务，用ambari-server reset命令重置ambari数据库



- 删除节点所有的软件

  ```
  yum remove `yum list | grep @HDP | awk '{print $1}'` -y
  
  ```




获取集群页面

http://ambari.bigdata.org:8080/views/ADMIN_VIEW/2.7.0.0/INSTANCE/#/clusterInformation



防火墙

```
firewall-cmd --state #查看默认防火墙状态（关闭后显示notrunning，开启后显示running）
[root@localhost ~]#firewall-cmd --state
not running


systemctl stop firewalld.service #停止firewall
systemctl disable firewalld.service #禁止firewall开机启动
```



```

```

----------------



### 重装 ambari

```
yum -y remove smartsense-hst
yum -y install smartsense-hst
```

